import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

// 42 أحاديث الأربعين النووية كاملة
const COMPLETE_HADITHS = [
  {
    number: 1,
    title: "الأعمال بالنيات",
    arabic_text: "إنما الأعمال بالنيات، وإنما لكل امرئ ما نوى، فمن كانت هجرته إلى الله ورسوله فهجرته إلى الله ورسوله، ومن كانت هجرته لدنيا يصيبها أو امرأة ينكحها فهجرته إلى ما هاجر إليه.",
    narrator: "عمر بن الخطاب رضي الله عنه"
  },
  {
    number: 2,
    title: "مراتب الدين",
    arabic_text: "بينما نحن عند رسول الله صلى الله عليه وسلم ذات يوم، إذ طلع علينا رجل شديد بياض الثياب، شديد سواد الشعر، لا يرى عليه أثر السفر، ولا يعرفه منا أحد، حتى جلس إلى النبي صلى الله عليه وسلم، فأسند ركبتيه إلى ركبتيه، ووضع كفيه على فخذيه، وقال: يا محمد، أخبرني عن الإسلام، فقال رسول الله صلى الله عليه وسلم: الإسلام أن تشهد أن لا إله إلا الله وأن محمدا رسول الله، وتقيم الصلاة، وتؤتي الزكاة، وتصوم رمضان، وتحج البيت إن استطعت إليه سبيلا، قال: صدقت.",
    narrator: "عمر بن الخطاب رضي الله عنه"
  },
  {
    number: 3,
    title: "أركان الإسلام",
    arabic_text: "بني الإسلام على خمس: شهادة أن لا إله إلا الله وأن محمدا رسول الله، وإقام الصلاة، وإيتاء الزكاة، وحج البيت، وصوم رمضان.",
    narrator: "عبد الله بن عمر رضي الله عنهما"
  },
  {
    number: 4,
    title: "مراحل الخلق",
    arabic_text: "إن أحدكم يجمع خلقه في بطن أمه أربعين يوما نطفة، ثم يكون علقة مثل ذلك، ثم يكون مضغة مثل ذلك، ثم يرسل إليه الملك فينفخ فيه الروح، ويؤمر بأربع كلمات: بكتب رزقه، وأجله، وعمله، وشقي أو سعيد. فوالذي لا إله غيره، إن أحدكم ليعمل بعمل أهل الجنة حتى ما يكون بينه وبينها إلا ذراع فيسبق عليه الكتاب فيعمل بعمل أهل النار فيدخلها، وإن أحدكم ليعمل بعمل أهل النار حتى ما يكون بينه وبينها إلا ذراع فيسبق عليه الكتاب فيعمل بعمل أهل الجنة فيدخلها.",
    narrator: "عبد الله بن مسعود رضي الله عنه"
  },
  {
    number: 5,
    title: "رد المحدثات",
    arabic_text: "من أحدث في أمرنا هذا ما ليس منه فهو رد.",
    narrator: "عائشة رضي الله عنها"
  },
  {
    number: 6,
    title: "الحلال بين",
    arabic_text: "إن الحلال بين، وإن الحرام بين، وبينهما أمور مشتبهات لا يعلمهن كثير من الناس، فمن اتقى الشبهات فقد استبرأ لدينه وعرضه، ومن وقع في الشبهات وقع في الحرام، كالراعي يرعى حول الحمى يوشك أن يرتع فيه، ألا وإن لكل ملك حمى، ألا وإن حمى الله محارمه، ألا وإن في الجسد مضغة إذا صلحت صلح الجسد كله، وإذا فسدت فسد الجسد كله، ألا وهي القلب.",
    narrator: "النعمان بن بشير رضي الله عنهما"
  },
  {
    number: 7,
    title: "الدين النصيحة",
    arabic_text: "الدين النصيحة، قلنا: لمن؟ قال: لله ولكتابه ولرسوله ولأئمة المسلمين وعامتهم.",
    narrator: "تميم الداري رضي الله عنه"
  },
  {
    number: 8,
    title: "حرمة دم المسلم",
    arabic_text: "أمرت أن أقاتل الناس حتى يشهدوا أن لا إله إلا الله، وأن محمدا رسول الله، ويقيموا الصلاة، ويؤتوا الزكاة، فإذا فعلوا ذلك عصموا مني دماءهم وأموالهم إلا بحق الإسلام، وحسابهم على الله تعالى.",
    narrator: "عبد الله بن عمر رضي الله عنهما"
  },
  {
    number: 9,
    title: "ما نهيتكم عنه فاجتنبوه",
    arabic_text: "ما نهيتكم عنه فاجتنبوه، وما أمرتكم به فأتوا منه ما استطعتم، فإنما أهلك الذين من قبلكم كثرة مسائلهم واختلافهم على أنبيائهم.",
    narrator: "أبو هريرة رضي الله عنه"
  },
  {
    number: 10,
    title: "الطيب من الكسب",
    arabic_text: "إن الله طيب لا يقبل إلا طيبا، وإن الله أمر المؤمنين بما أمر به المرسلين، فقال تعالى: {يا أيها الرسل كلوا من الطيبات واعملوا صالحا}، وقال تعالى: {يا أيها الذين آمنوا كلوا من طيبات ما رزقناكم}، ثم ذكر الرجل يطيل السفر أشعث أغبر، يمد يديه إلى السماء: يا رب، يا رب، ومطعمه حرام، ومشربه حرام، وملبسه حرام، وغذي بالحرام، فأنى يستجاب لذلك.",
    narrator: "أبو هريرة رضي الله عنه"
  },
  {
    number: 11,
    title: "دع ما يريبك",
    arabic_text: "دع ما يريبك إلى ما لا يريبك.",
    narrator: "الحسن بن علي رضي الله عنهما"
  },
  {
    number: 12,
    title: "حسن إسلام المرء",
    arabic_text: "من حسن إسلام المرء تركه ما لا يعنيه.",
    narrator: "أبو هريرة رضي الله عنه"
  },
  {
    number: 13,
    title: "لا يؤمن أحدكم",
    arabic_text: "لا يؤمن أحدكم حتى يحب لأخيه ما يحب لنفسه.",
    narrator: "أنس بن مالك رضي الله عنه"
  },
  {
    number: 14,
    title: "حرمة دم المسلم",
    arabic_text: "لا يحل دم امرئ مسلم إلا بإحدى ثلاث: الثيب الزاني، والنفس بالنفس، والتارك لدينه المفارق للجماعة.",
    narrator: "عبد الله بن مسعود رضي الله عنه"
  },
  {
    number: 15,
    title: "من كان يؤمن بالله",
    arabic_text: "من كان يؤمن بالله واليوم الآخر فليقل خيرا أو ليصمت، ومن كان يؤمن بالله واليوم الآخر فليكرم جاره، ومن كان يؤمن بالله واليوم الآخر فليكرم ضيفه.",
    narrator: "أبو هريرة رضي الله عنه"
  },
  {
    number: 16,
    title: "لا تغضب",
    arabic_text: "لا تغضب.",
    narrator: "أبو هريرة رضي الله عنه"
  },
  {
    number: 17,
    title: "الإحسان في كل شيء",
    arabic_text: "إن الله كتب الإحسان على كل شيء، فإذا قتلتم فأحسنوا القتلة، وإذا ذبحتم فأحسنوا الذبحة، وليحد أحدكم شفرته، وليرح ذبيحته.",
    narrator: "شداد بن أوس رضي الله عنه"
  },
  {
    number: 18,
    title: "اتق الله حيثما كنت",
    arabic_text: "اتق الله حيثما كنت، وأتبع السيئة الحسنة تمحها، وخالق الناس بخلق حسن.",
    narrator: "أبو ذر الغفاري ومعاذ بن جبل رضي الله عنهما"
  },
  {
    number: 19,
    title: "آمن بالقدر",
    arabic_text: "احفظ الله يحفظك، احفظ الله تجده تجاهك، إذا سألت فاسأل الله، وإذا استعنت فاستعن بالله، واعلم أن الأمة لو اجتمعت على أن ينفعوك بشيء لم ينفعوك إلا بشيء قد كتبه الله لك، وإن اجتمعوا على أن يضروك بشيء لم يضروك إلا بشيء قد كتبه الله عليك، رفعت الأقلام وجفت الصحف.",
    narrator: "عبد الله بن عباس رضي الله عنهما"
  },
  {
    number: 20,
    title: "الحياء من الإيمان",
    arabic_text: "إن مما أدرك الناس من كلام النبوة الأولى: إذا لم تستح فاصنع ما شئت.",
    narrator: "أبو مسعود الأنصاري رضي الله عنه"
  },
  {
    number: 21,
    title: "قل آمنت بالله ثم استقم",
    arabic_text: "قل آمنت بالله ثم استقم.",
    narrator: "سفيان بن عبد الله الثقفي رضي الله عنه"
  },
  {
    number: 22,
    title: "طريق الجنة",
    arabic_text: "قلت: يا رسول الله، دلني على عمل يدخلني الجنة، قال: تعبد الله لا تشرك به شيئا، وتقيم الصلاة، وتؤتي الزكاة، وتصل الرحم.",
    narrator: "أبو هريرة رضي الله عنه"
  },
  {
    number: 23,
    title: "الطهور",
    arabic_text: "الطهور شطر الإيمان، والحمد لله تملأ الميزان، وسبحان الله والحمد لله تملآن أو تملأ ما بين السماء والأرض، والصلاة نور، والصدقة برهان، والصبر ضياء، والقرآن حجة لك أو عليك، كل الناس يغدو، فبائع نفسه فمعتقها أو موبقها.",
    narrator: "أبو مالك الأشعري رضي الله عنه"
  },
  {
    number: 24,
    title: "تحريم الظلم",
    arabic_text: "يا عبادي، إني حرمت الظلم على نفسي وجعلته بينكم محرما فلا تظالموا. يا عبادي، كلكم ضال إلا من هديته، فاستهدوني أهدكم. يا عبادي، كلكم جائع إلا من أطعمته، فاستطعموني أطعمكم. يا عبادي، كلكم عار إلا من كسوته، فاستكسوني أكسكم.",
    narrator: "أبو ذر الغفاري رضي الله عنه"
  },
  {
    number: 25,
    title: "فضل الذكر والاستغفار",
    arabic_text: "كل سلامى من الناس عليه صدقة، كل يوم تطلع فيه الشمس: تعدل بين اثنين صدقة، وتعين الرجل في دابته فتحمله عليها أو ترفع له عليها متاعه صدقة، والكلمة الطيبة صدقة، وبكل خطوة تمشيها إلى الصلاة صدقة، وتميط الأذى عن الطريق صدقة.",
    narrator: "أبو هريرة رضي الله عنه"
  },
  {
    number: 26,
    title: "كل معروف صدقة",
    arabic_text: "كل معروف صدقة.",
    narrator: "جابر بن عبد الله رضي الله عنه"
  },
  {
    number: 27,
    title: "البر والإثم",
    arabic_text: "البر حسن الخلق، والإثم ما حاك في نفسك وكرهت أن يطلع عليه الناس.",
    narrator: "النواس بن سمعان ووابصة بن معبد رضي الله عنهما"
  },
  {
    number: 28,
    title: "وصية بالنساء",
    arabic_text: "اتقوا الله في النساء، فإنكم أخذتموهن بأمان الله، واستحللتم فروجهن بكلمة الله.",
    narrator: "أبو هريرة رضي الله عنه"
  },
  {
    number: 29,
    title: "باب ما جاء في الجنة",
    arabic_text: "من سلك طريقا يلتمس فيه علما، سهل الله له به طريقا إلى الجنة، وإن الملائكة لتضع أجنحتها رضا لطالب العلم، وإن العالم ليستغفر له من في السماوات ومن في الأرض، حتى الحيتان في الماء، وفضل العالم على العابد كفضل القمر على سائر الكواكب، وإن العلماء ورثة الأنبياء، وإن الأنبياء لم يورثوا دينارا ولا درهما، إنما ورثوا العلم، فمن أخذه أخذ بحظ وافر.",
    narrator: "أبو الدرداء رضي الله عنه"
  },
  {
    number: 30,
    title: "حق الله على العباد",
    arabic_text: "إن لله على الناس حقا، وإن للناس على الله حقا، فحق الله على الناس أن يعبدوه ولا يشركوا به شيئا، وحق الناس على الله أن لا يعذب من لا يشرك به شيئا.",
    narrator: "معاذ بن جبل رضي الله عنه"
  },
  {
    number: 31,
    title: "الزهد في الدنيا",
    arabic_text: "ازهد في الدنيا يحبك الله، وازهد فيما عند الناس يحبك الناس.",
    narrator: "سهل بن سعد الساعدي رضي الله عنه"
  },
  {
    number: 32,
    title: "لا ضرر ولا ضرار",
    arabic_text: "لا ضرر ولا ضرار.",
    narrator: "أبو سعيد الخدري رضي الله عنه"
  },
  {
    number: 33,
    title: "البينة على المدعي",
    arabic_text: "البينة على المدعي، واليمين على من أنكر.",
    narrator: "عبد الله بن عباس رضي الله عنهما"
  },
  {
    number: 34,
    title: "النهي عن المنكر",
    arabic_text: "من رأى منكم منكرا فليغيره بيده، فإن لم يستطع فبلسانه، فإن لم يستطع فبقلبه، وذلك أضعف الإيمان.",
    narrator: "أبو سعيد الخدري رضي الله عنه"
  },
  {
    number: 35,
    title: "الأخوة في الله",
    arabic_text: "لا تحاسدوا، ولا تناجشوا، ولا تباغضوا، ولا تدابروا، ولا يبع بعضكم على بيع بعض، وكونوا عباد الله إخوانا. المسلم أخو المسلم، لا يظلمه ولا يخذله ولا يحقره، التقوى ها هنا -ويشير إلى صدره ثلاث مرات- بحسب امرئ من الشر أن يحقر أخاه المسلم، كل المسلم على المسلم حرام: دمه وماله وعرضه.",
    narrator: "أبو هريرة رضي الله عنه"
  },
  {
    number: 36,
    title: "قضاء حوائج المسلمين",
    arabic_text: "من نفس عن مؤمن كربة من كرب الدنيا نفس الله عنه كربة من كرب يوم القيامة، ومن يسر على معسر يسر الله عليه في الدنيا والآخرة، ومن ستر مسلما ستره الله في الدنيا والآخرة، والله في عون العبد ما كان العبد في عون أخيه.",
    narrator: "أبو هريرة رضي الله عنه"
  },
  {
    number: 37,
    title: "فضل الأعمال",
    arabic_text: "إن الله كتب الحسنات والسيئات، ثم بين ذلك، فمن هم بحسنة فلم يعملها كتبها الله عنده حسنة كاملة، وإن هم بها فعملها كتبها الله عنده عشر حسنات إلى سبعمائة ضعف إلى أضعاف كثيرة، وإن هم بسيئة فلم يعملها كتبها الله عنده حسنة كاملة، وإن هم بها فعملها كتبها الله سيئة واحدة.",
    narrator: "عبد الله بن عباس رضي الله عنهما"
  },
  {
    number: 38,
    title: "محبة الله للعبد",
    arabic_text: "إن الله تعالى قال: من عادى لي وليا فقد آذنته بالحرب، وما تقرب إلي عبدي بشيء أحب إلي مما افترضت عليه، وما يزال عبدي يتقرب إلي بالنوافل حتى أحبه، فإذا أحببته كنت سمعه الذي يسمع به، وبصره الذي يبصر به، ويده التي يبطش بها، ورجله التي يمشي بها، وإن سألني لأعطينه، ولئن استعاذني لأعيذنه.",
    narrator: "أبو هريرة رضي الله عنه"
  },
  {
    number: 39,
    title: "التجاوز عن الخطأ",
    arabic_text: "إن الله تجاوز لي عن أمتي الخطأ والنسيان وما استكرهوا عليه.",
    narrator: "عبد الله بن عباس رضي الله عنهما"
  },
  {
    number: 40,
    title: "كن في الدنيا كأنك غريب",
    arabic_text: "كن في الدنيا كأنك غريب أو عابر سبيل.",
    narrator: "عبد الله بن عمر رضي الله عنهما"
  },
  {
    number: 41,
    title: "اتباع السنة",
    arabic_text: "لا يؤمن أحدكم حتى يكون هواه تبعا لما جئت به.",
    narrator: "عبد الله بن عمرو بن العاص رضي الله عنهما"
  },
  {
    number: 42,
    title: "سعة مغفرة الله",
    arabic_text: "قال الله تبارك وتعالى: يا ابن آدم، إنك ما دعوتني ورجوتني غفرت لك على ما كان منك ولا أبالي. يا ابن آدم، لو بلغت ذنوبك عنان السماء ثم استغفرتني غفرت لك ولا أبالي. يا ابن آدم، إنك لو أتيتني بقراب الأرض خطايا ثم لقيتني لا تشرك بي شيئا لأتيتك بقرابها مغفرة.",
    narrator: "أنس بن مالك رضي الله عنه"
  }
];

Deno.serve(async (req) => {
  try {
    const base44 = createClientFromRequest(req);
    
    // Verify admin authentication
    const user = await base44.auth.me();
    if (!user || user.role !== 'admin') {
      return Response.json({ error: 'Unauthorized - Admin only' }, { status: 401 });
    }

    // Get existing hadiths to check which ones need import
    const existingHadiths = await base44.asServiceRole.entities.Hadith.list();
    const existingNumbers = new Set(existingHadiths.map(h => h.number));

    let imported = 0;
    let skipped = 0;
    let updated = 0;

    for (const hadith of COMPLETE_HADITHS) {
      if (existingNumbers.has(hadith.number)) {
        // Update existing hadith if text is shorter (incomplete)
        const existing = existingHadiths.find(h => h.number === hadith.number);
        if (existing && existing.arabic_text.length < hadith.arabic_text.length) {
          await base44.asServiceRole.entities.Hadith.update(existing.id, hadith);
          updated++;
        } else {
          skipped++;
        }
      } else {
        // Import new hadith
        await base44.asServiceRole.entities.Hadith.create({
          ...hadith,
          source: "الأربعون النووية"
        });
        imported++;
      }
    }

    return Response.json({
      success: true,
      message: `تم استيراد ${imported} حديث جديد، تحديث ${updated} حديث، تخطي ${skipped} حديث موجود`,
      total: COMPLETE_HADITHS.length,
      imported,
      updated,
      skipped
    });

  } catch (error) {
    console.error('Error importing hadiths:', error);
    return Response.json({ 
      error: error.message,
      success: false 
    }, { status: 500 });
  }
});